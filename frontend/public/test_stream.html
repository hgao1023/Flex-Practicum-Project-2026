<!DOCTYPE html>
<html>
<head><title>SSE Stream Test</title></head>
<body>
<h2>SSE Stream Test</h2>
<button onclick="testStream()">Send Query</button>
<div id="steps" style="font-family:monospace; margin:20px 0;"></div>
<div id="thinking" style="background:#fef3c7; padding:10px; margin:10px 0; display:none; white-space:pre-wrap;"></div>
<div id="response" style="background:#f0f0f0; padding:10px; margin:10px 0; white-space:pre-wrap;"></div>
<script>
async function testStream() {
  document.getElementById('steps').innerHTML = '';
  document.getElementById('thinking').style.display = 'none';
  document.getElementById('thinking').textContent = '';
  document.getElementById('response').textContent = '';
  
  const res = await fetch('http://localhost:8001/api/chat/stream', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({query: 'What is Flex CapEx 2025?', mode: 'rag', include_web: false})
  });
  
  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  
  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, {stream: true});
    
    const lines = buffer.split('\n');
    buffer = lines.pop();
    
    let eventType = '';
    for (const line of lines) {
      if (line.startsWith('event: ')) {
        eventType = line.slice(7).trim();
      } else if (line.startsWith('data: ') && eventType) {
        try {
          const data = JSON.parse(line.slice(6));
          if (eventType === 'step') {
            document.getElementById('steps').innerHTML += '<div>' + data.icon + ' ' + data.label + ': ' + data.detail + '</div>';
          } else if (eventType === 'thinking_start') {
            document.getElementById('thinking').style.display = 'block';
            document.getElementById('thinking').textContent = 'Thinking: ';
          } else if (eventType === 'thinking') {
            document.getElementById('thinking').textContent += data.text;
          } else if (eventType === 'token') {
            document.getElementById('response').textContent += data.text;
          }
        } catch(e) {}
        eventType = '';
      }
    }
  }
}
</script>
</body>
</html>
